<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Usuário - CRUD Estático com Mixpanel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Mixpanel JS Snippet -->
    <script type="text/javascript">
        // Mixpanel JavaScript SDK v2.43.0
        // Este snippet é fornecido pelo Mixpanel para inicialização e autocapture
        (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(a,c,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}};var k=f(b,"track show setup get set register unregister alias identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove people.callback_with_proxy group.set group.set_once group.unset group.remove group.union group.get_group group.track_event group.init_group group.add_group group.remove_group group.on_group_set".split(" "));for(g=0;g<k.length;g++)i=k[g],f(d||a,i);b._i.push([a,c,d])};b.__SV=1.2;e=f(b,"config enable all disable all track_pageview register_once".split(" "));for(g=0;g<e.length;g++)i=e[g],f(i);b.alias=function(a,c){b.push([f,"alias",a,c])};b.super=function(a,c){b.push([f,"super",a,c])};b.track_links=function(a,c){b.push([f,"track_links",a,c])};b.track_forms=function(a,c){b.push([f,"track_forms",a,c])};b.cookie=f(b,"cookie enable cookie disable cookie get cookie set cookie remove".split(" "));h=["disable","enable","setup","track","track_links","track_forms","register","register_once","unregister","identify","alias","name_tag","set_config","people.set","people.set_once","people.increment","people.append","people.union","people.track_charge","people.clear_charges","people.delete_user"];for(g=0;g<h.length;g++)f(b,h[g]);f(b,"__SV");a=document.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===document.location.protocol?"https:":"http:")+
            '//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js';var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)}})(document,window.mixpanel||[]);
        
        // Inicializa o Mixpanel com o token fornecido e modo debug
        mixpanel.init("a4fcef66b785c74222dc494cc55f1f6a", {debug: true}); 
    </script>
    <!-- Fim do Snippet Mixpanel -->

</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 flex flex-col items-center p-4 font-inter text-gray-800">

    <!-- Message Box -->
    <div id="message-box" style="display: none;" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-50"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Confirmar Exclusão</h3>
            <p class="mb-6 text-gray-700">Tem certeza de que deseja excluir o usuário <span id="modal-user-name" class="font-bold"></span>?</p>
            <div class="flex justify-end space-x-4">
                <button
                    onclick="cancelDelete()"
                    class="px-6 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out"
                >
                    Cancelar
                </button>
                <button
                    onclick="confirmDelete()"
                    class="px-6 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition duration-150 ease-in-out"
                >
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <h1 class="text-4xl font-bold mb-8 text-indigo-800 drop-shadow-md">
        Cadastro de Usuário Estático
    </h1>

    <!-- User Form -->
    <div class="w-full max-w-2xl bg-white p-8 rounded-xl shadow-lg mb-8">
        <h2 id="form-title" class="text-2xl font-semibold mb-6 text-indigo-700">Novo Usuário</h2>
        <form id="user-form" onsubmit="handleSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Nome -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  oninput="handleChange(event)"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
            </div>
            <!-- Sobrenome -->
            <div>
                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Sobrenome</label>
                <input
                  type="text"
                  id="lastName"
                  name="lastName"
                  oninput="handleChange(event)"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
            </div>
            <!-- Idade -->
            <div>
                <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Idade</label>
                <input
                  type="number"
                  id="age"
                  name="age"
                  oninput="handleChange(event)"
                  required
                  min="0"
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
            </div>
            <!-- Endereço -->
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                <input
                  type="text"
                  id="address"
                  name="address"
                  oninput="handleChange(event)"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
            </div>
            <!-- Estado -->
            <div>
                <label for="state" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                <input
                  type="text"
                  id="state"
                  name="state"
                  oninput="handleChange(event)"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
            </div>
            <!-- Estado Civil -->
            <div>
                <label for="maritalStatus" class="block text-sm font-medium text-gray-700 mb-1">Estado Civil</label>
                <select
                  id="maritalStatus"
                  name="maritalStatus"
                  onchange="handleChange(event)"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <option value="Solteiro(a)">Solteiro(a)</option>
                  <option value="Casado(a)">Casado(a)</option>
                  <option value="Divorciado(a)">Divorciado(a)</option>
                  <option value="Viúvo(a)">Viúvo(a)</option>
                </select>
            </div>
            <!-- Possui Habilitação -->
            <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Possui Habilitação?</label>
                <div class="mt-1 flex items-center space-x-4">
                  <label class="inline-flex items-center">
                    <input
                      type="radio"
                      name="hasLicense"
                      value="Sim"
                      onchange="handleChange(event)"
                      class="form-radio text-indigo-600"
                    />
                    <span class="ml-2 text-gray-700">Sim</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input
                      type="radio"
                      name="hasLicense"
                      value="Não"
                      onchange="handleChange(event)"
                      class="form-radio text-indigo-600"
                    />
                    <span class="ml-2 text-gray-700">Não</span>
                  </label>
                </div>
            </div>
            <!-- Qual o iPhone -->
            <div class="col-span-1 md:col-span-2">
                <label for="iphoneModel" class="block text-sm font-medium text-gray-700 mb-1">Qual o iPhone?</label>
                <select
                  id="iphoneModel"
                  name="iphoneModel"
                  onchange="handleChange(event)"
                  required
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <!-- As opções serão preenchidas por JavaScript -->
                </select>
            </div>

            <!-- Botões -->
            <div class="col-span-1 md:col-span-2 flex justify-end space-x-4 mt-4">
                <div id="cancel-button-container">
                    <!-- O botão de cancelar será renderizado aqui ao editar -->
                </div>
                <button
                  type="submit"
                  id="submit-button"
                  class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-lg font-semibold rounded-full text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out transform hover:scale-105"
                >
                  Cadastrar
                </button>
            </div>
        </form>
    </div>

    <!-- Lista de Usuários -->
    <div class="w-full max-w-4xl bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-6 text-indigo-700">Usuários Cadastrados</h2>
        <p id="no-users-message" class="text-center text-gray-500">Nenhum usuário cadastrado ainda.</p>
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm" style="display: none;">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sobrenome</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Idade</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Habilitação</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">iPhone</th>
                  <th scope="col" class="relative px-6 py-3">
                    <span class="sr-only">Ações</span>
                  </th>
                </tr>
              </thead>
              <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                <!-- As linhas de usuário serão renderizadas aqui -->
              </tbody>
            </table>
          </div>
    </div>

    <script>
        // Variáveis globais para o aplicativo
        // Carrega usuários do localStorage ou inicializa um array vazio
        let users = JSON.parse(localStorage.getItem('users')) || []; 
        let editingUser = null; // Usuário atualmente em edição
        let formData = { // Dados do formulário
            name: '',
            lastName: '',
            age: '',
            address: '',
            state: '',
            maritalStatus: 'Solteiro(a)',
            hasLicense: 'Não',
            iphoneModel: 'iPhone 6' // Primeiro modelo da lista
        };
        let message = { type: '', text: '' }; // Mensagens de feedback
        let showConfirmModal = false; // Estado do modal de confirmação
        let userToDelete = null; // Usuário a ser excluído

        // Define iPhone models from iPhone 6 to current
        const iPhoneModels = [
            'iPhone 6', 'iPhone 6 Plus', 'iPhone 6S', 'iPhone 6S Plus',
            'iPhone 7', 'iPhone 7 Plus', 'iPhone 8', 'iPhone 8 Plus',
            'iPhone X', 'iPhone XR', 'iPhone XS', 'iPhone XS Max',
            'iPhone 11', 'iPhone 11 Pro', 'iPhone 11 Pro Max',
            'iPhone 12 Mini', 'iPhone 12', 'iPhone 12 Pro', 'iPhone 12 Pro Max',
            'iPhone 13 Mini', 'iPhone 13', 'iPhone 13 Pro', 'iPhone 13 Pro Max',
            'iPhone 14', 'iPhone 14 Plus', 'iPhone 14 Pro', 'iPhone 14 Pro Max',
            'iPhone 15', 'iPhone 15 Plus', 'iPhone 15 Pro', 'iPhone 15 Pro Max',
        ];

        // Salva os usuários no localStorage
        const saveUsersToLocalStorage = () => {
            localStorage.setItem('users', JSON.stringify(users));
        };

        // Function to show message box
        const showMessageBox = (type, text) => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
                messageBox.textContent = '';
            }, 5000);
        };

        // Function to handle form input changes
        const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            formData = {
                ...formData,
                [name]: type === 'radio' ? (checked ? value : formData[name]) : value
            };
        };

        // Function to handle form submission
        const handleSubmit = (e) => {
            e.preventDefault();
            
            // Simula um ID para o usuário no modo estático
            const newUserId = editingUser ? editingUser.id : 'user_' + Date.now(); 

            if (editingUser) {
                // Atualiza usuário existente na lista local
                users = users.map(user => 
                    user.id === editingUser.id ? { ...formData, id: newUserId } : user
                );
                showMessageBox('success', 'Usuário atualizado com sucesso!');
                // Rastreia o evento de edição no Mixpanel
                if (window.mixpanel) {
                    mixpanel.track('Edição de Usuário', { ...formData, id: newUserId }); 
                }
                editingUser = null;
            } else {
                // Adiciona novo usuário à lista local
                users.push({ ...formData, id: newUserId });
                showMessageBox('success', 'Usuário criado com sucesso!');
                // Rastreia o evento de cadastro no Mixpanel
                if (window.mixpanel) {
                    mixpanel.track('Cadastro de Usuário', { ...formData, id: newUserId }); 
                }
            }
            
            // Salva no localStorage
            saveUsersToLocalStorage();

            // Reseta os dados do formulário
            formData = {
                name: '',
                lastName: '',
                age: '',
                address: '',
                state: '',
                maritalStatus: 'Solteiro(a)',
                hasLicense: 'Não',
                iphoneModel: iPhoneModels[0]
            };
            renderForm(); // Re-renderiza o formulário para limpar inputs e atualizar o botão
            renderUserList(); // Re-renderiza a lista de usuários
        };

        // Function to set user for editing
        const handleEdit = (user) => {
            editingUser = user;
            formData = { ...user }; // Preenche o formulário com os dados do usuário
            renderForm(); // Re-renderiza o formulário para mostrar o estado de edição
        };

        // Function to prepare for user deletion (show confirmation modal)
        const handleDeleteClick = (user) => {
            userToDelete = user;
            showConfirmModal = true;
            renderConfirmModal();
        };

        // Function to confirm deletion and proceed
        const confirmDelete = () => {
            if (!userToDelete) {
                showMessageBox('error', 'Nenhum usuário para excluir.');
                return;
            }

            // Rastreia o evento de exclusão no Mixpanel
            if (window.mixpanel) {
                mixpanel.track('Exclusão de Usuário', { id: userToDelete.id, name: userToDelete.name, lastName: userToDelete.lastName }); 
            }

            // Remove o usuário da lista local
            users = users.filter(user => user.id !== userToDelete.id);
            showMessageBox('success', 'Usuário excluído com sucesso!');
            
            // Salva no localStorage
            saveUsersToLocalStorage();

            showConfirmModal = false;
            userToDelete = null;
            renderConfirmModal(); // Esconde o modal
            renderUserList(); // Re-renderiza a lista de usuários
        };

        // Function to cancel deletion
        const cancelDelete = () => {
            showConfirmModal = false;
            userToDelete = null;
            renderConfirmModal(); // Esconde o modal
        };

        // Function to cancel editing
        const handleCancelEdit = () => {
            editingUser = null;
            formData = {
                name: '',
                lastName: '',
                age: '',
                address: '',
                state: '',
                maritalStatus: 'Solteiro(a)',
                hasLicense: 'Não',
                iphoneModel: iPhoneModels[0]
            };
            renderForm(); // Re-renderiza o formulário para limpar inputs
        };

        // Function to render the entire app (or parts that need re-rendering)
        const renderApp = () => {
            renderForm();
            renderUserList();
            renderConfirmModal();
        };

        // Function to render the form
        const renderForm = () => {
            const formElement = document.getElementById('user-form');
            if (!formElement) return;

            const isEditing = !!editingUser;
            document.getElementById('form-title').textContent = isEditing ? 'Editar Usuário' : 'Novo Usuário';
            document.getElementById('submit-button').textContent = isEditing ? 'Salvar Edição' : 'Cadastrar';

            // Preenche os campos do formulário
            document.getElementById('name').value = formData.name;
            document.getElementById('lastName').value = formData.lastName;
            document.getElementById('age').value = formData.age;
            document.getElementById('address').value = formData.address;
            document.getElementById('state').value = formData.state;
            document.getElementById('maritalStatus').value = formData.maritalStatus;

            // Botões de rádio para hasLicense
            // Garante que o rádio correto é marcado
            document.querySelector(`input[name="hasLicense"][value="Sim"]`).checked = (formData.hasLicense === 'Sim');
            document.querySelector(`input[name="hasLicense"][value="Não"]`).checked = (formData.hasLicense === 'Não');

            // Dropdown para iphoneModel
            const iphoneSelect = document.getElementById('iphoneModel');
            if (iphoneSelect) {
                iphoneSelect.value = formData.iphoneModel;
            }
            

            const cancelButtonContainer = document.getElementById('cancel-button-container');
            if (isEditing) {
                cancelButtonContainer.innerHTML = `
                    <button
                        type="button"
                        onclick="handleCancelEdit()"
                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out"
                    >
                        Cancelar Edição
                    </button>
                `;
            } else {
                cancelButtonContainer.innerHTML = '';
            }
        };

        // Function to render the user list
        const renderUserList = () => {
            const userListBody = document.getElementById('user-list-body');
            const noUsersMessage = document.getElementById('no-users-message');

            if (!userListBody || !noUsersMessage) return;

            if (users.length === 0) {
                noUsersMessage.style.display = 'block';
                userListBody.innerHTML = ''; // Limpa a tabela
                userListBody.closest('.overflow-x-auto').style.display = 'none'; // Esconde o contêiner da tabela
            } else {
                noUsersMessage.style.display = 'none';
                userListBody.closest('.overflow-x-auto').style.display = 'block'; // Mostra o contêiner da tabela
                userListBody.innerHTML = users.map(user => `
                    <tr key="${user.id}" class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.lastName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.age}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.state}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.hasLicense}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.iphoneModel}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button
                                onclick="handleEdit(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(user))}')))"
                                class="text-indigo-600 hover:text-indigo-900 mr-4 transition duration-150 ease-in-out"
                            >
                                Editar
                            </button>
                            <button
                                onclick="handleDeleteClick(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(user))}')))"
                                class="text-red-600 hover:text-red-900 transition duration-150 ease-in-out"
                            >
                                Excluir
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        };

        // Function to render the confirmation modal
        const renderConfirmModal = () => {
            const modal = document.getElementById('confirmation-modal');
            const userNameSpan = document.getElementById('modal-user-name');
            if (!modal || !userNameSpan) return;

            if (showConfirmModal && userToDelete) {
                userNameSpan.textContent = `${userToDelete.name} ${userToDelete.lastName}`;
                modal.style.display = 'flex'; // Show modal
            } else {
                modal.style.display = 'none'; // Hide modal
            }
        };

        // Popula as opções do iPhone na inicialização
        const populateIphoneModels = () => {
            const selectElement = document.getElementById('iphoneModel');
            if (selectElement) {
                selectElement.innerHTML = iPhoneModels.map(model => `<option value="${model}">${model}</option>`).join('');
                selectElement.value = formData.iphoneModel; // Define o valor inicial
            }
        };

        // Renderiza tudo na carga inicial
        window.onload = () => {
            populateIphoneModels();
            renderApp();
        };

        // Certifique-se de que o estado inicial dos rádios 'hasLicense' seja aplicado
        // Este observador garante que o estado do rádio é aplicado mesmo após re-renderizações do formulário
        document.addEventListener('DOMContentLoaded', () => {
            const formElement = document.getElementById('user-form');
            if (formElement) {
                const observer = new MutationObserver(() => {
                    // Garante que os valores dos campos de rádio sejam atualizados após a renderização do formulário
                    document.querySelector(`input[name="hasLicense"][value="Sim"]`).checked = (formData.hasLicense === 'Sim');
                    document.querySelector(`input[name="hasLicense"][value="Não"]`).checked = (formData.hasLicense === 'Não');
                });
                observer.observe(formElement, { childList: true, subtree: true, attributes: true });
            }
        });
    </script>
</body>
</html>
